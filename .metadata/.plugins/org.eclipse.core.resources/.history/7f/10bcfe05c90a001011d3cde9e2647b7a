package com.lms.attendance.controller;

import java.util.List;
import java.util.Map;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.lms.attendance.model.Survey;
import com.lms.attendance.model.SurveyBoard;
import com.lms.attendance.service.SurveyService;

@RestController
@RequestMapping("/api/surveys") // âœ… API ê¸°ë³¸ ê²½ë¡œ
public class SurveyController {

    private final SurveyService surveyService;

    public SurveyController(SurveyService surveyService) {
        this.surveyService = surveyService;
    }

    /** âœ… íŠ¹ì • ê°•ì˜ì‹¤ì˜ ëª¨ë“  ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒ ì¡°íšŒ */
    @GetMapping("/boards/{classId}")
    public ResponseEntity<List<SurveyBoard>> getSurveyBoards(@PathVariable("classId") int classId) {
        return ResponseEntity.ok(surveyService.getSurveyBoardsByClassId(classId));
    }

    /** âœ… ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒ ìƒì„± */
    @PostMapping("/board/{classId}")
    public ResponseEntity<SurveyBoard> createSurveyBoard(@PathVariable("classId") int classId) {
        SurveyBoard createdBoard = surveyService.createSurveyBoard(classId);
        if (createdBoard == null) {
            return ResponseEntity.badRequest().build();
        }
        return ResponseEntity.ok(createdBoard);
    }

    /** âœ… íŠ¹ì • ê²Œì‹œíŒì˜ ì„¤ë¬¸ì¡°ì‚¬ ëª©ë¡ ì¡°íšŒ */
    @GetMapping("/board/{boardId}/surveys")
    public ResponseEntity<List<Survey>> getSurveysByBoard(@PathVariable("boardId") int boardId) {
        return ResponseEntity.ok(surveyService.getSurveysByBoard(boardId));
    }

    /** âœ… ì„¤ë¬¸ì¡°ì‚¬ + ì§ˆë¬¸ì„ í•œ ë²ˆì— ì €ì¥ */
    @PostMapping("/create")
    public ResponseEntity<Survey> createSurveyWithQuestions(@RequestBody Survey survey) {
        if (survey == null || survey.getQuestions() == null || survey.getQuestions().isEmpty()) {
            return ResponseEntity.badRequest().body(null); // âœ… ìš”ì²­ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ê²½ìš° 400 ë°˜í™˜
        }

        // âœ… ìš”ì²­ ë°ì´í„° ë¡œê¹…
        System.out.println("ğŸ“Œ ìš”ì²­ëœ ì„¤ë¬¸ì¡°ì‚¬ ë°ì´í„°: " + survey.toString());

        Survey createdSurvey = surveyService.createSurveyWithQuestions(survey);
        if (createdSurvey == null) {
            return ResponseEntity.badRequest().build();
        }
        
        // ì›¹ì†Œì¼“ ì•Œë¦¼ ì „ì†¡
        Integer boardId = createdSurvey.getBoardId(); // ëª¨ë¸ì— boardId ì¡´ì¬
        Integer classId = surveyMapper.findClassIdBySurveyBoardId(boardId);
        
        if (classId == null) {
            System.err.println("âŒ í•´ë‹¹ boardId(" + boardId + ")ì— í•´ë‹¹í•˜ëŠ” classIdê°€ ì—†ìŠµë‹ˆë‹¤.");
            return ResponseEntity.badRequest().body(null); // ë˜ëŠ” ì˜ˆì™¸ ë˜ì§€ê¸°
        }

        AlarmMessage message = new AlarmMessage(
            "SURVEY",
            createdSurvey.getTitle(),
            LocalDateTime.now().toString(),
            classId
        );
     // ì•ˆì „í•˜ê²Œ WebSocket ì•Œë¦¼ ì „ì†¡
        alarmSender.sendToUsersInClass(classId, new AlarmMessage(
            "SURVEY", createdSurvey.getTitle(), LocalDateTime.now().toString(), classId
        ));
        
        return ResponseEntity.ok(createdSurvey);
    }
    
    /** âœ… íŠ¹ì • ì„¤ë¬¸ì¡°ì‚¬ ìƒì„¸ ì¡°íšŒ */
    @GetMapping("/survey/{surveyId}")
    public ResponseEntity<Survey> getSurveyDetail(@PathVariable("surveyId") int surveyId) {
        Survey survey = surveyService.getSurveyDetail(surveyId);
        if (survey == null) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(survey);
    }
    
    /** íŠ¹ì • ì„¤ë¬¸ì¡°ì‚¬ì˜ ì‘ë‹µ ê°€ëŠ¥ ì‹œê°„ ë³€ê²½ */
    @PutMapping("/{surveyId}/update-times")
    public ResponseEntity<?> updateSurveyTimes(@PathVariable("surveyId") Long surveyId, 
                                               @RequestBody Map<String, String> request) {
        String newStartTime = request.get("startTime");
        String newEndTime = request.get("endTime");
        boolean success = surveyService.updateSurveyTimes(surveyId, newStartTime, newEndTime);

        return success ? ResponseEntity.ok("ì„¤ë¬¸ ì‹œê°„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.") :
                         ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
    }
    
    @DeleteMapping("/{surveyId}")
    public ResponseEntity<String> deleteSurvey(@PathVariable("surveyId") Integer surveyId) {
        boolean deleted = surveyService.deleteSurvey(surveyId);

        if (deleted) {
            return ResponseEntity.ok("ì„¤ë¬¸ì¡°ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body("ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
    /** âœ… ì„¤ë¬¸ ìˆ˜ì • API */
    @PutMapping("/{surveyId}/update")
    public ResponseEntity<String> updateSurvey(
            @PathVariable("surveyId") int surveyId,
            @RequestBody Survey updatedSurvey) {
        updatedSurvey.setSurveyId(surveyId);
        boolean isUpdated = surveyService.updateSurveyWithQuestions(updatedSurvey);
        if (isUpdated) {
            return ResponseEntity.ok("âœ… ì„¤ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            return ResponseEntity.badRequest().body("âŒ ì„¤ë¬¸ ìˆ˜ì • ì‹¤íŒ¨");
        }
    }
}

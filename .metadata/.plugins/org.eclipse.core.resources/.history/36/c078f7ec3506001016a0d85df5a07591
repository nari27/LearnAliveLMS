package com.lms.attendance.controller;

import java.util.List;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.lms.attendance.model.Exam;
import com.lms.attendance.model.ExamResult;
import com.lms.attendance.model.ExamStudentAnswer;
import com.lms.attendance.service.ExamService;
import com.lms.attendance.service.ExamSubmissionService;

import lombok.RequiredArgsConstructor;

@RestController
@RequestMapping("/api/exams")
@RequiredArgsConstructor
public class ExamController {
    private final ExamService examService;
    private final ExamSubmissionService examSubmissionService;

    // ìƒˆë¡œìš´ ì‹œí—˜ ì¶”ê°€ (ì‹œí—˜ê³¼ ì§ˆë¬¸ í¬í•¨)
    @PostMapping
    public ResponseEntity<String> createExam(@RequestBody Exam exam) {
        System.out.println("ì‹œí—˜ ë°ì´í„°: " + exam); // ì „ì†¡ ë°ì´í„° í™•ì¸
        examService.createExam(exam);  // ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ë“¤ê¹Œì§€ ì €ì¥
        return ResponseEntity.ok("ì‹œí—˜ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // íŠ¹ì • í´ë˜ìŠ¤ì˜ ì‹œí—˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    @GetMapping
    public ResponseEntity<List<Exam>> getExams(@RequestParam("classId") int classId) {
        System.out.println("ğŸ” ìš”ì²­ ë°›ì€ classId: " + classId);  // classId ê°’ í™•ì¸
        List<Exam> exams = examService.getExamsByClassId(classId);
        System.out.println("ğŸ” ê°€ì ¸ì˜¨ ì‹œí—˜ ëª©ë¡: " + exams);  // ê°€ì ¸ì˜¨ ë°ì´í„° í™•ì¸
        return ResponseEntity.ok(exams);
    }

    // íŠ¹ì • ì‹œí—˜ ìƒì„¸ ë³´ê¸° (ì‹œí—˜ê³¼ ì§ˆë¬¸ í¬í•¨)
    @GetMapping("/{examId}")
    public ResponseEntity<Exam> getExam(@PathVariable("examId") int examId) {
        System.out.println("ğŸ” ìš”ì²­ ë°›ì€ examId: " + examId);
        Exam exam = examService.getExamById(examId);  // ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ í•¨ê»˜ ê°€ì ¸ì˜´
        System.out.println("ğŸ” ê°€ì ¸ì˜¨ ì‹œí—˜ ë°ì´í„°: " + exam);
        return ResponseEntity.ok(exam);
    }

    // ì‹œí—˜ ì‚­ì œ (ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ë„ ì‚­ì œ)
    @DeleteMapping("/{examId}")
    public ResponseEntity<Void> deleteExam(@PathVariable("examId") int examId) {
        examService.deleteExam(examId);  // ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ë„ í•¨ê»˜ ì‚­ì œ
        return ResponseEntity.ok().build();
    }

    // ì‹œí—˜ ìˆ˜ì • (ì‹œí—˜ê³¼ ì§ˆë¬¸ í¬í•¨)
    @PutMapping("/{examId}")
    public ResponseEntity<Exam> updateExam(@PathVariable("examId") int examId, @RequestBody Exam exam) {
        System.out.println("ìˆ˜ì • ìš”ì²­ ë°ì´í„°: " + exam);  // ë¡œê·¸ ì°ì–´ì„œ ë°ì´í„° í™•ì¸
        exam.setExamId(examId); // examIdë¥¼ exam ê°ì²´ì— ì„¤ì •
        examService.updateExam(exam);  // ì‹œí—˜ê³¼ ì§ˆë¬¸ ìˆ˜ì •
        return ResponseEntity.ok(exam); // ìˆ˜ì •ëœ ì‹œí—˜ ê°ì²´ ë°˜í™˜
    }
    
 // ì‹œí—˜ ê²Œì‹œíŒ ìƒì„± (Exam_Board)
    @PostMapping("/board")
    public ResponseEntity<String> createQuizBoard(@RequestParam("classId") int classId) {
        examService.createQuizBoard(classId);
        return ResponseEntity.ok("í€´ì¦ˆ ê²Œì‹œíŒì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

 // í•™ìƒì´ ì‹œí—˜ì„ ì œì¶œ
    @PostMapping("/submit")
    public ResponseEntity<String> submitExam(@RequestBody ExamStudentAnswer examStudentAnswer) {
        System.out.println("ì‹œí—˜ ì œì¶œ ë°ì´í„°: " + examStudentAnswer);
        examSubmissionService.submitExam(examStudentAnswer);
        return ResponseEntity.ok("ì‹œí—˜ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    
// ì‹œí—˜ê²°ê³¼
    @GetMapping("/examResult/{examId}")
    public ResponseEntity<ExamResult> getExamResult(@PathVariable int examId, @RequestParam String studentId) {
    	ExamResult result = examSubmissionService.getExamResult(examId, studentId); 
    	System.out.println("==== >>>>");
    	System.out.println(result.getAnswers());
    	return ResponseEntity.ok(result);
    }

}
package com.lms.attendance.controller;

import java.util.List;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.lms.attendance.model.Exam;
import com.lms.attendance.service.ExamService;

import lombok.RequiredArgsConstructor;

@RestController
@RequestMapping("/api/exams")
@RequiredArgsConstructor
public class ExamController {
    private final ExamService examService;

    // ìƒˆë¡œìš´ ì‹œí—˜ ì¶”ê°€ (ì‹œí—˜ê³¼ ì§ˆë¬¸ í¬í•¨)
    @PostMapping
    public ResponseEntity<String> createExam(@RequestBody Exam exam) {
        System.out.println("ì‹œí—˜ ë°ì´í„°: " + exam); // ì „ì†¡ ë°ì´í„° í™•ì¸
        examService.createExam(exam);  // ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ë“¤ê¹Œì§€ ì €ì¥
        return ResponseEntity.ok("ì‹œí—˜ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // íŠ¹ì • í´ë˜ìŠ¤ì˜ ì‹œí—˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    @GetMapping
    public ResponseEntity<List<Exam>> getExams(@RequestParam("classId") int classId) {
        System.out.println("ğŸ” ìš”ì²­ ë°›ì€ classId: " + classId);  // classId ê°’ í™•ì¸
        List<Exam> exams = examService.getExamsByClassId(classId);
        System.out.println("ğŸ” ê°€ì ¸ì˜¨ ì‹œí—˜ ëª©ë¡: " + exams);  // ê°€ì ¸ì˜¨ ë°ì´í„° í™•ì¸
        return ResponseEntity.ok(exams);
    }

    // íŠ¹ì • ì‹œí—˜ ìƒì„¸ ë³´ê¸° (ì‹œí—˜ê³¼ ì§ˆë¬¸ í¬í•¨)
    @GetMapping("/{examId}")
    public ResponseEntity<Exam> getExam(@PathVariable("examId") int examId) {
        System.out.println("ğŸ” ìš”ì²­ ë°›ì€ examId: " + examId);
        Exam exam = examService.getExamById(examId);  // ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ í•¨ê»˜ ê°€ì ¸ì˜´
        System.out.println("ğŸ” ê°€ì ¸ì˜¨ ì‹œí—˜ ë°ì´í„°: " + exam);
        return ResponseEntity.ok(exam);
    }

    // ì‹œí—˜ ì‚­ì œ (ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ë„ ì‚­ì œ)
    @DeleteMapping("/{examId}")
    public ResponseEntity<Void> deleteExam(@PathVariable("examId") int examId) {
        examService.deleteExam(examId);  // ì‹œí—˜ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ë„ í•¨ê»˜ ì‚­ì œ
        return ResponseEntity.ok().build();
    }

    // ì‹œí—˜ ìˆ˜ì • (ì‹œí—˜ê³¼ ì§ˆë¬¸ í¬í•¨)
    @PutMapping("/{examId}")
    public ResponseEntity<Exam> updateExam(@PathVariable("examId") int examId, @RequestBody Exam exam) {
        System.out.println("ìˆ˜ì • ìš”ì²­ ë°ì´í„°: " + exam);  // ë¡œê·¸ ì°ì–´ì„œ ë°ì´í„° í™•ì¸
        exam.setExamId(examId); // examIdë¥¼ exam ê°ì²´ì— ì„¤ì •
        examService.updateExam(exam);  // ì‹œí—˜ê³¼ ì§ˆë¬¸ ìˆ˜ì •
        return ResponseEntity.ok(exam); // ìˆ˜ì •ëœ ì‹œí—˜ ê°ì²´ ë°˜í™˜
    }
    
 // í€´ì¦ˆ ê²Œì‹œíŒ ìƒì„± (Exam_Board)
    @PostMapping("/board")
    public ResponseEntity<String> createQuizBoard(@RequestParam("classId") int classId) {
        examService.createQuizBoard(classId);
        return ResponseEntity.ok("í€´ì¦ˆ ê²Œì‹œíŒì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // ì„±ì (ì ìˆ˜, ë“±ê¸‰) ì—…ë°ì´íŠ¸ API
    @PutMapping("/{classId}/grade")
    public ResponseEntity<?> updateClassGrade(@PathVariable("classId") int classId,
                                              @RequestBody Map<String, Object> payload) {
        Object scoreObj = payload.get("score");
        Object gradeObj = payload.get("grade");
        if (scoreObj == null || gradeObj == null) {
            return ResponseEntity.badRequest().body("ì„±ì  ì •ë³´(score, grade)ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        Double score;
        try {
            score = Double.valueOf(scoreObj.toString());
        } catch (NumberFormatException e) {
            return ResponseEntity.badRequest().body("ìœ íš¨í•œ score ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
        String grade = gradeObj.toString();
        examService.updateClassGrade(classId, score, grade);
        return ResponseEntity.ok("ì„±ì  ì—…ë°ì´íŠ¸ ì„±ê³µ");
    }
    
    @PutMapping("/{classId}/description")
    public ResponseEntity<?> updateClassDescription(@PathVariable("classId") int classId,
                                                    @RequestBody Map<String, String> payload) {
        String description = payload.get("description");
        if (description == null) {
            return ResponseEntity.badRequest().body("ì„¤ëª… ë‚´ìš©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        examService.updateClassDescription(classId, description);
        return ResponseEntity.ok("ê°•ì˜ ì„¤ëª… ì—…ë°ì´íŠ¸ ì„±ê³µ");
    }
}
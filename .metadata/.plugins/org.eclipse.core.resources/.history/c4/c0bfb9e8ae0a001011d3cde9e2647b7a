package com.lms.attendance.controller;

import com.lms.attendance.model.Attendance;
import com.lms.attendance.service.AttendanceService;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/attendance")
public class AttendanceController {

    private final AttendanceService attendanceService;

    public AttendanceController(AttendanceService attendanceService) {
        this.attendanceService = attendanceService;
    }

    @GetMapping("/class/{classId}/date/{date}")
    public ResponseEntity<List<Attendance>> getAttendanceByClassAndDate(
            @PathVariable("classId") int classId, 
            @PathVariable("date") String date) {

        List<Attendance> attendanceList = attendanceService.getAttendanceByClassAndDate(classId, date);

        return ResponseEntity.ok(attendanceList);  // ë¹„ì–´ìˆì–´ë„ 200ìœ¼ë¡œ ë¦¬í„´
    }
    
    // âœ… í•™ìƒì´ ì§ì ‘ ì¶œì„í•˜ëŠ” API
    @PostMapping("/check-in")
    public ResponseEntity<Map<String, Object>> checkIn(@RequestBody Attendance request) {
        System.out.println("ğŸ“… ì„œë²„ì—ì„œ ë°›ì€ ì¶œì„ ìš”ì²­ ë°ì´í„°: " + request);

        // âœ… ì„œë²„ê°€ ë°›ì€ date ê°’ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
        System.out.println("ğŸ“Œ ë°›ì€ student_id: " + request.getStudentId());
        System.out.println("ğŸ“Œ ë°›ì€ class_id: " + request.getClassId());
        System.out.println("ğŸ“Œ ë°›ì€ date: " + request.getDate());

        Map<String, Object> response = attendanceService.studentCheckIn(request);
        return ResponseEntity.ok(response);
    }


 // âœ… ì¶œì„ ìƒíƒœ(state) ë³€ê²½
    @PutMapping("/{attendanceId}/state")
    public ResponseEntity<?> updateAttendanceState(
        @PathVariable("attendanceId") int attendanceId, // â† ëª…ì‹œì ìœ¼ë¡œ ë³€ìˆ˜ëª… ì¶”ê°€
        @RequestBody Map<String, String> payload
    ) {
        String state = payload.get("state");
        if (state == null || state.isEmpty()) {
            return ResponseEntity.badRequest().body("ì¶œì„ ìƒíƒœ ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        attendanceService.updateAttendanceState(attendanceId, state);
        return ResponseEntity.ok("ì¶œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ");
    }

    // âœ… ì¶œì„ ì‚¬ìœ (reason) ë³€ê²½
    @PutMapping("/{attendanceId}/reason")
    public ResponseEntity<?> updateAttendanceReason(
        @PathVariable("attendanceId") int attendanceId, // â† ëª…ì‹œì ìœ¼ë¡œ ë³€ìˆ˜ëª… ì¶”ê°€
        @RequestBody Map<String, String> payload
    ) {
        String reason = payload.get("reason");
        if (reason == null || reason.isEmpty()) {
            return ResponseEntity.badRequest().body("ì¶œì„ ì‚¬ìœ  ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        attendanceService.updateAttendanceReason(attendanceId, reason);
        return ResponseEntity.ok("ì¶œì„ ì‚¬ìœ  ì—…ë°ì´íŠ¸ ì„±ê³µ");
    }


    // âœ… ì¶œì„ ê¸°ë¡ ì¶”ê°€
    @PostMapping("/add")
    public ResponseEntity<?> addAttendance(@RequestBody Attendance request) {
        attendanceService.addAttendance(request);
        return ResponseEntity.ok("ì¶œì„ ê¸°ë¡ ì¶”ê°€ ì™„ë£Œ");
    }

    // âœ… ì¶œì„ ê¸°ë¡ ì‚­ì œ API
    @DeleteMapping("/{attendanceId}")
    public ResponseEntity<?> deleteAttendance(@PathVariable("attendanceId") int attendanceId) {
        attendanceService.deleteAttendance(attendanceId);
        return ResponseEntity.ok("ì¶œì„ ê¸°ë¡ ì‚­ì œ ì„±ê³µ");
    }
    
    @GetMapping("/student/{studentId}")
    public ResponseEntity<List<Attendance>> getAttendanceByStudent(
            @PathVariable("studentId") String studentId, 
            @RequestParam("date") String date) {
        
        List<Attendance> attendanceList = attendanceService.getAttendanceByStudent(studentId, date);
        
        if (attendanceList.isEmpty()) {
            return ResponseEntity.noContent().build();
        }
        return ResponseEntity.ok(attendanceList);
    }
    
    // í•™ìƒì˜ ì›”ë³„ ì¶œì„ ê¸°ë¡ ì¡°íšŒ (ì˜ˆ: /api/attendance/student/1/month?month=2025-03)
    @GetMapping("/student/{studentId}/month")
    public ResponseEntity<List<Attendance>> getMonthlyAttendance(
            @PathVariable("studentId") String studentId,
            @RequestParam("month") String month) {
        List<Attendance> attendanceList = attendanceService.getMonthlyAttendance(studentId, month);
        if (attendanceList.isEmpty()) {
            return ResponseEntity.noContent().build();
        }
        return ResponseEntity.ok(attendanceList);
    }
    
	 // ì§€ë‚œ ì¶œì„ ë°ì´í„° ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸
	 // ì˜ˆ: GET /api/attendance/student/1/past?endDate=2025-03-18
	 @GetMapping("/student/{studentId}/past")
	 public ResponseEntity<List<Attendance>> getPastAttendance(
	         @PathVariable String studentId,
	         @RequestParam String endDate) {
	     List<Attendance> attendanceList = attendanceService.getPastAttendance(studentId, endDate);
	     if (attendanceList.isEmpty()) {
	         return ResponseEntity.noContent().build();
	     }
	     return ResponseEntity.ok(attendanceList);
	 }
}

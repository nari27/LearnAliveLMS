package com.lms.attendance.controller;

import java.util.List;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.web.bind.annotation.*;

import com.lms.attendance.model.Professor;
import com.lms.attendance.service.ProfessorService;

import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;

@CrossOrigin(origins = "http://localhost:5173")
@RestController
@RequestMapping("/api/professors")
@RequiredArgsConstructor
public class ProfessorController {

    private final ProfessorService professorService;
    private final BCryptPasswordEncoder passwordEncoder;

    // âœ… ëª¨ë“  êµìˆ˜ ì¡°íšŒ (ê´€ë¦¬ìë§Œ ê°€ëŠ¥)
    @GetMapping
    public ResponseEntity<?> getAllProfessors() {
        if (!isAdmin()) {
            return ResponseEntity.status(403).body(Map.of("success", false, "message", "ê´€ë¦¬ìë§Œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        }
        List<Professor> professors = professorService.getAllProfessors();
        return ResponseEntity.ok(professors);
    }

    // âœ… êµìˆ˜ ë“±ë¡ (ê´€ë¦¬ìë§Œ ê°€ëŠ¥)
    @PostMapping("/add")
    public ResponseEntity<?> registerProfessor(@RequestBody Professor professor) {
        if (!isAdmin()) {
            return ResponseEntity.status(403).body(Map.of("success", false, "message", "ê´€ë¦¬ìë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."));
        }
        if (professor.getProf_id() == null || professor.getProf_id().isEmpty()) {
            return ResponseEntity.badRequest().body(Map.of("success", false, "message", "êµìˆ˜ IDëŠ” í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤."));
        }
        professorService.saveProfessor(professor);
        return ResponseEntity.ok(Map.of("success", true, "message", "êµìˆ˜ ë“±ë¡ ì™„ë£Œ"));
    }

    // âœ… êµìˆ˜ ì •ë³´ ìˆ˜ì • (ê´€ë¦¬ìë§Œ ê°€ëŠ¥)
    @PutMapping("/{prof_id}")
    public ResponseEntity<?> updateProfessor(@PathVariable("prof_id") String prof_id,
                                             @RequestBody Professor updatedProfessor) {
        if (!isAdmin()) {
            return ResponseEntity.status(403).body(Map.of("success", false, "message", "ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."));
        }

        if (updatedProfessor.getPassword() != null && !updatedProfessor.getPassword().isEmpty()) {
            updatedProfessor.setPassword(passwordEncoder.encode(updatedProfessor.getPassword()));
        }

        professorService.updateProfessor(updatedProfessor);
        return ResponseEntity.ok(Map.of("success", true, "message", "êµìˆ˜ ì •ë³´ ì—…ë°ì´íŠ¸ ì„±ê³µ"));
    }

    // âœ… êµìˆ˜ ì‚­ì œ (ê´€ë¦¬ìë§Œ ê°€ëŠ¥)
    @DeleteMapping("/{prof_id}")
    public ResponseEntity<?> deleteProfessor(@PathVariable("prof_id") String prof_id) {
        if (!isAdmin()) {
            return ResponseEntity.status(403).body(Map.of("success", false, "message", "ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."));
        }
        professorService.deleteProfessor(prof_id);
        return ResponseEntity.ok(Map.of("success", true, "message", "êµìˆ˜ ì‚­ì œ ì™„ë£Œ"));
    }

    // âœ… ID ì°¾ê¸°
    @PostMapping("/find-id")
    public ResponseEntity<?> findProfessorId(@RequestBody Map<String, String> request) {
        String name = request.get("name");
        String email = request.get("email");

        Professor professor = professorService.findByNameAndEmail(name, email);
        if (professor == null) {
            return ResponseEntity.status(404).body(Map.of("success", false, "message", "í•´ë‹¹ ì •ë³´ì™€ ì¼ì¹˜í•˜ëŠ” IDê°€ ì—†ìŠµë‹ˆë‹¤."));
        }

        return ResponseEntity.ok(Map.of("success", true, "userId", professor.getProf_id()));
    }

    // âœ… ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
    @PostMapping("/reset-password")
    public ResponseEntity<?> resetProfessorPassword(@RequestBody Map<String, String> request) {
        String userId = request.get("userId");
        String name = request.get("name");
        String phone = request.get("phone");
        String newPassword = request.get("newPassword");

        if (userId == null || name == null || phone == null || newPassword == null ||
            userId.isEmpty() || name.isEmpty() || phone.isEmpty() || newPassword.isEmpty()) {
            return ResponseEntity.badRequest().body(Map.of("success", false, "message", "ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."));
        }

        Professor professor = professorService.findByIdAndNameAndPhone(userId, name, phone);
        if (professor == null) {
            return ResponseEntity.status(404).body(Map.of("success", false, "message", "ì¼ì¹˜í•˜ëŠ” ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }

        professor.setPassword(newPassword); // ë¹„ë°€ë²ˆí˜¸ëŠ” ì•”í˜¸í™” ë¡œì§ í¬í•¨ë˜ì–´ ìˆìŒ
        professorService.updateProfessor(professor);

        return ResponseEntity.ok(Map.of("success", true, "message", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."));
    }

    // âœ… í˜„ì¬ ì‚¬ìš©ì ê¶Œí•œì´ adminì¸ì§€ í™•ì¸
    private boolean isAdmin() {
        String role = SecurityContextHolder.getContext().getAuthentication()
                .getAuthorities().stream()
                .findFirst()
                .map(Object::toString)
                .orElse("");

        System.out.println("ğŸ§ª í˜„ì¬ ìš”ì²­ìì˜ ROLE: " + role);

        return "ROLE_ADMIN".equalsIgnoreCase(role);
    }

    @PostConstruct
    public void check() {
        System.out.println("âœ…âœ…âœ… ProfessorController Bean ìƒì„± ì™„ë£Œ âœ…âœ…âœ…");
    }
}
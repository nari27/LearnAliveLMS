package com.lms.attendance.service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.lms.attendance.model.Attendance;
import com.lms.attendance.repository.AttendanceMapper;

@Service
public class AttendanceServiceImpl implements AttendanceService {

    private final AttendanceMapper attendanceMapper;
    private final WebSocketService webSocketService;

    public AttendanceServiceImpl(AttendanceMapper attendanceMapper, WebSocketService webSocketService) {
        this.attendanceMapper = attendanceMapper;
        this.webSocketService = webSocketService;
    }
 
    // âœ… íŠ¹ì • ë‚ ì§œ ì¶œì„ ë°ì´í„° ì¡°íšŒ
    @Override
    public List<Attendance> getAttendanceByClassAndDate(int classId, String date) {
        List<Attendance> attendanceList = attendanceMapper.findAttendanceByClassAndDate(classId, date);

        // âœ… createdAt, updatedAt null â†’ "" ë³€í™˜ ì²˜ë¦¬
        for (Attendance att : attendanceList) {
            if (att.getCreatedAt() == null) att.setCreatedAt("");
            if (att.getUpdatedAt() == null) att.setUpdatedAt("");
        }
        return attendanceList;
    }


    // âœ… ì¶œì„ ìƒíƒœ ë³€ê²½
    @Override
    @Transactional
    public void updateAttendanceState(int attendanceId, String state, String studentId) {
        attendanceMapper.updateAttendanceState(attendanceId, state);
        checkAndSendFAlert(studentId); // âœ… ì „ì²´ ì´ë ¥ ê¸°ì¤€ ê²½ê³  íŒë‹¨
    }

    // âœ… ì¶œì„ ì‚¬ìœ  ë³€ê²½
    @Override
    @Transactional
    public void updateAttendanceReason(int attendanceId, String reason) {
        attendanceMapper.updateAttendanceReason(attendanceId, reason);
    }

    // âœ… ì¶œì„ ê¸°ë¡ ì¶”ê°€ (ì¤‘ë³µ ê²€ì‚¬)
    @Override
    @Transactional
    public void addAttendance(Attendance attendance) {
        int existingCount = attendanceMapper.checkDuplicateAttendance(
                attendance.getStudentId(), attendance.getClassId(), attendance.getDate());

        if (existingCount == 0) { // ê¸°ì¡´ ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš°ë§Œ ì¶”ê°€
            attendanceMapper.insertAttendance(
                    attendance.getStudentId(),
                    attendance.getClassId(),
                    attendance.getDate(),
                    attendance.getState());
            checkAndSendFAlert(attendance.getStudentId());
        }
    }

    // âœ… ì¶œì„ ê¸°ë¡ ì‚­ì œ
    @Override
    @Transactional
    public void deleteAttendance(int attendanceId) {
        attendanceMapper.deleteAttendance(attendanceId);
    }
    
    //í•™ìƒ ì¶œì„ ê¸°ë¡
 // ì¶œì„ ê¸°ë¡ ë°˜í™˜ ë©”ì„œë“œ ìˆ˜ì •
    @Override
    @Transactional
    public Map<String, Object> studentCheckIn(Attendance request) {
        Map<String, Object> response = new HashMap<>();

        // âœ… DBì—ì„œ ì¶œì„ ê°€ëŠ¥ ì‹œê°„ í™•ì¸
        String availability = attendanceMapper.checkAttendanceAvailability(request.getClassId());

        // âœ… ì¶œì„ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹ ê²½ìš°
        if ("early".equals(availability)) {
            response.put("message", "âŒ ì•„ì§ ì¶œì„ ê°€ëŠ¥í•œ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
            response.put("state", "none");
            return response;
        } 
        if ("late".equals(availability)) {
            response.put("message", "âŒ ìˆ˜ì—…ì´ ì¢…ë£Œëœ ì´í›„ì—ëŠ” ì¶œì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            response.put("state", "none");
            return response;
        }

        // âœ… ê¸°ì¡´ ì¶œì„ í™•ì¸
        int count = attendanceMapper.checkExistingAttendance(request.getStudentId(), request.getClassId(), request.getDate());
        if (count > 0) {
            Attendance existingAttendance = attendanceMapper.getAttendanceByStudentAndDate(request.getStudentId(), request.getClassId(), request.getDate());
            response.put("message", "â— ì´ë¯¸ ì¶œì„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            response.put("state", existingAttendance.getState());
            return response;
        }

        // âœ… ì •ìƒ ì¶œì„ ê¸°ë¡
        attendanceMapper.studentCheckIn(request);
        Attendance newAttendance = attendanceMapper.getAttendanceByStudentAndDate(request.getStudentId(), request.getClassId(), request.getDate());

        response.put("message", "âœ… ì¶œê²° ìƒíƒœê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        response.put("state", newAttendance.getState());
        return response;
    }

    @Override
    public List<Attendance> getAttendanceByStudent(String studentId, String date) {
        return attendanceMapper.findAttendanceByStudent(studentId, date);
    }
    
    @Override
    @Transactional
    public List<Attendance> getMonthlyAttendance(String studentId, String month) {
        return attendanceMapper.findAttendanceByStudentForMonth(studentId, month);
    }
    
    @Override
    @Transactional
    public List<Attendance> getPastAttendance(int studentId, String endDate) {
        List<Attendance> attendanceList = attendanceMapper.findPastAttendanceByStudent(studentId, endDate);
        for (Attendance att : attendanceList) {
            if (att.getCreatedAt() == null) att.setCreatedAt("");
            if (att.getUpdatedAt() == null) att.setUpdatedAt("");
        }
        return attendanceList;
    
    @Override
    @Transactional
 // ì¶œì„ ì´ë ¥ì— ë”°ë¥¸ Fí•™ì  ê²½ê³  ì „ì†¡
    public void checkAndSendFAlert(String studentId) {
        int absentCount = attendanceMapper.countAbsentsByStudentId(studentId); 
        int lateCount = attendanceMapper.countLatesByStudentId(studentId);     
        int virtualAbsents = absentCount + (lateCount / 2);

        System.out.println("ğŸ‘€ ì•Œë¦¼ ì²´í¬ ëŒ€ìƒ í•™ë²ˆ: " + studentId);
        System.out.println("ğŸ“Š ê²°ì„ íšŸìˆ˜: " + absentCount);
        System.out.println("ğŸ“Š ì§€ê° íšŸìˆ˜: " + lateCount);
        System.out.println("ğŸ“ˆ í™˜ì‚°ëœ ê²°ì„ íšŸìˆ˜: " + virtualAbsents);

        if (virtualAbsents >= 2) {
            System.out.println("ğŸš¨ Fí•™ì  ê²½ê³  ì•Œë¦¼ ì „ì†¡ ì‹œì‘");
            // WebSocketServiceë¥¼ í†µí•´ í•™ìƒê³¼ êµìˆ˜ìì—ê²Œ ì•Œë¦¼ì„ ì „ì†¡í•˜ê³ , DBì— ì €ì¥
            webSocketService.sendFGradeWarning(
                studentId,
                "í˜„ì¬ê¹Œì§€ ê²°ì„ " + absentCount + "íšŒ, ì§€ê° " + lateCount + "íšŒì…ë‹ˆë‹¤. ì¶œì„ì— ìœ ì˜í•˜ì„¸ìš”!",
                1 // ì˜ˆì‹œë¡œ í´ë˜ìŠ¤ IDê°€ 1ë²ˆì´ë¼ê³  ê°€ì •
            );
        } else {
            System.out.println("âœ… Fí•™ì  ì¡°ê±´ ë¯¸ì¶©ì¡±, ì•Œë¦¼ ì „ì†¡ ìƒëµ");
        }
    }

}
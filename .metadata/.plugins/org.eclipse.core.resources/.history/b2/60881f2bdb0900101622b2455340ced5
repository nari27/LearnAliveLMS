package com.lms.attendance.controller;

import java.util.List;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.lms.attendance.model.ClassDetail;
import com.lms.attendance.model.ClassSettings;
import com.lms.attendance.model.Classroom;
import com.lms.attendance.service.ClassService;

@RestController
@RequestMapping("/api/classes")
public class ClassController {

    private static final Logger logger = LoggerFactory.getLogger(ClassController.class);
    private final ClassService classService;

    public ClassController(ClassService classService) {
        this.classService = classService;
    }

    @GetMapping("/user/{userId}")
    public List<Classroom> getUserClasses(@PathVariable("userId") String userId) {
        logger.info("ğŸ“Œ [DEBUG] ê°•ì˜ì‹¤ ëª©ë¡ ì¡°íšŒ ìš”ì²­ ë„ì°©: userId={}", userId);

        List<Classroom> classes = classService.getClassesByUserId(userId);

        logger.info("ğŸ“Œ [DEBUG] ì¡°íšŒëœ ê°•ì˜ì‹¤ ê°œìˆ˜: {}", classes.size());
        logger.info("ğŸ“Œ [DEBUG] ì¡°íšŒëœ ê°•ì˜ì‹¤ ë¦¬ìŠ¤íŠ¸: {}", classes);  // âœ… ë¦¬ìŠ¤íŠ¸ ì „ì²´ ì¶œë ¥

        return classes;
    }
    
    @GetMapping("/all")
    public ResponseEntity<List<Classroom>> getAllClasses() {
        List<Classroom> classes = classService.getAllClasses();
        System.out.println("ğŸ“Œ ë¶ˆëŸ¬ì˜¨ ê°•ì˜ì‹¤ ëª©ë¡: " + classes); // âœ… ì½˜ì†” ë¡œê·¸ í™•ì¸
        return ResponseEntity.ok(classes);
    }


    
    @PostMapping("/add")
    public ResponseEntity<?> addClassroom(@RequestBody Classroom newClass) {
        System.out.println("ë°›ì€ ê°’: " + newClass);
        classService.addClassroom(newClass);
        return ResponseEntity.ok("ê°•ì˜ì‹¤ ì¶”ê°€ ì™„ë£Œ");
    }
    
 // âœ… ê°•ì˜ì‹¤ ì‚­ì œ API ì¶”ê°€
    @DeleteMapping("/{classId}")
    public ResponseEntity<?> deleteClass(@PathVariable("classId") int classId) {
        classService.deleteClassById(classId);
        return ResponseEntity.ok("ê°•ì˜ì‹¤ ì‚­ì œ ì„±ê³µ");
    }
    
 // âœ… íŠ¹ì • ê°•ì˜ì‹¤ì˜ ì¶œì„ ì‹œê°„ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    @GetMapping("/{classId}/settings")
    public ResponseEntity<?> getClassSettings(@PathVariable("classId") int classId) {  // âœ… @PathVariableì— ì´ë¦„ ëª…ì‹œ
        ClassSettings settings = classService.getClassSettingsById(classId);
        if (settings != null) {
            return ResponseEntity.ok(settings);
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body("ê°•ì˜ì‹¤ ì¶œì„ ì‹œê°„ ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
 // âœ… ì¶œì„ ì‹œê°„ ì„¤ì • ì €ì¥ API ì¶”ê°€
    @PutMapping("/{classId}/settings")
    public ResponseEntity<?> updateClassSettings(@PathVariable("classId") int classId, @RequestBody ClassSettings settings) {
        settings.setClassId(classId);  // âœ… URLì—ì„œ ë°›ì€ classIdë¥¼ ê°ì²´ì— ì„¤ì •
        classService.updateClassSettings(settings);
        return ResponseEntity.ok("âœ… ì¶œì„ ì‹œê°„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    
    //classIdë¡œ ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ ë””í…Œì¼ ê°ì²´ í”„ë¡ íŠ¸ë¡œ ë³´ë‚´ì£¼ë„ë¡
    @GetMapping("/detail/{classId}")
    public ResponseEntity<ClassDetail> getClassDetail(@PathVariable("classId") int classId) {
        ClassDetail classDetail = classService.getClassDetail(classId);
        System.out.println("ğŸ“Œ ë°±ì—”ë“œ ì‘ë‹µ ë°ì´í„°: " + classDetail); // âœ… ì„œë²„ì—ì„œ ë°ì´í„° ë¡œê·¸ ì¶œë ¥
        if (classDetail == null) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(null);
        }
        return ResponseEntity.ok(classDetail);
    }
    
    // ì„±ì (ì ìˆ˜, ë“±ê¸‰) ì—…ë°ì´íŠ¸ API
    @PutMapping("/{classId}/grade")
    public ResponseEntity<?> updateClassGrade(@PathVariable("classId") int classId,
                                              @RequestBody Map<String, Object> payload) {
        Object scoreObj = payload.get("score");
        Object gradeObj = payload.get("grade");
        if (scoreObj == null || gradeObj == null) {
            return ResponseEntity.badRequest().body("ì„±ì  ì •ë³´(score, grade)ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        Double score;
        try {
            score = Double.valueOf(scoreObj.toString());
        } catch (NumberFormatException e) {
            return ResponseEntity.badRequest().body("ìœ íš¨í•œ score ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
        String grade = gradeObj.toString();
        classService.updateClassGrade(classId, score, grade);
        return ResponseEntity.ok("ì„±ì  ì—…ë°ì´íŠ¸ ì„±ê³µ");
    }
    
    @PutMapping("/{classId}/description")
    public ResponseEntity<?> updateClassDescription(@PathVariable("classId") int classId,
                                                    @RequestBody Map<String, String> payload) {
        String description = payload.get("description");
        if (description == null) {
            return ResponseEntity.badRequest().body("ì„¤ëª… ë‚´ìš©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        classService.updateClassDescription(classId, description);
        return ResponseEntity.ok("ê°•ì˜ ì„¤ëª… ì—…ë°ì´íŠ¸ ì„±ê³µ");
    }
}
